library(tidyverse)

vic_mammal_traits = readRDS("data_clean/vic_mammal_traits.Rds")

names(vic_mammal_traits)
str(vic_mammal_traits)
hist(vic_mammal_traits$dispersal_km)

# Function to make the scores
convert_to_scores = function(vect, invert){
  # Determine the quantile thresholds
  #q <- quantile(vect, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
  q <- BAMMtools::getJenksBreaks(vect, k=3, subset = NULL)
  # Use cut to convert the values into quantile scores
  scores <- cut(vect, 
                breaks = c(-Inf, q[1], q[2], q[3], Inf),
                if(invert==TRUE){labels = c(1, 0.66, 0.33, 0)
                }else{labels = c(0, 0.33, 0.66, 1)}, 
                include.lowest = TRUE)
  
  # Convert to numeric for calculations if necessary
  scores <- as.numeric(as.character(scores))
  return(scores)
}

# Scoring per trait
vic_mammal_scores = 
  vic_mammal_traits %>% select(TAXON_ID, Sci_Name, COMMON_NAME, 
                                                 TaxaGroup, TAXON_TYPE, Extinction_Risk, Sci_Name_Alt) %>%
  mutate(score_mass = convert_to_scores(vic_mammal_traits$Mass_g, invert=TRUE),
         score_homerange = convert_to_scores(vic_mammal_traits$home_range_km2, invert=TRUE),
         score_dispersal = convert_to_scores(vic_mammal_traits$dispersal_km, invert=TRUE),
         score_habitat_breadth = ifelse(vic_mammal_traits$habitat_breadth_n <3, 1, 0),
         score_foraging_stratum = case_when(vic_mammal_traits$foraging_stratum == "A" ~ 0.66,
                                            vic_mammal_traits$foraging_stratum == "G" ~ 0.66,
                                            vic_mammal_traits$foraging_stratum == "Ar" ~ 1),
         score_torpor = case_when(vic_mammal_traits$hibernation_torpor==1~0, vic_mammal_traits$hibernation_torpor==0~1),
         score_diet_breadth = ifelse(vic_mammal_traits$det_diet_breadth_n <3, 1, 0),
         score_n_offspring = convert_to_scores(vic_mammal_traits$n_offspring_year, invert=TRUE),
         score_plant_diet = ifelse(vic_mammal_traits$dphy_plant>49, 1, 0),
         score_inv_diet = ifelse(vic_mammal_traits$dphy_invertebrate>49, 1, 0))

# Add up the vulnerability scores
vic_mammal_scores$sum_vulnerability_score = rowSums(vic_mammal_scores[, 8:17], na.rm = TRUE)
vic_mammal_scores$number_traits = rowSums(!is.na(vic_mammal_scores[, 8:17]))

# Calculate the proportion
vic_mammal_scores$vulnerability_score = vic_mammal_scores$sum_vulnerability_score/vic_mammal_scores$number_traits

saveRDS(vic_mammal_scores, "data_clean/vic_mammal_scores.Rds")
