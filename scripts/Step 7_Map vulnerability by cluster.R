# ------------------------------------------------------------------------------
# Script Name: Step 7_Map vulnerability
# Author: Billy Geary
# Date Created: 17/12/2024
# Last Modified: 17/12/2024
# Purpose: This script maps the vulnerability of specific species clusters to aspects 
#          of the fire regime, using information from FAME and SMP
# Outputs: Maps of vulnerability for each species cluster, based on SMP and FAME data. 
#          Only a few examples have been generated so far. 
# ------------------------------------------------------------------------------
library(terra)
library(sf)
library(tidyverse)

maps = list.files("/Volumes/proj-6600_deeca_fire_2024-1128.4.1096/deeca_data/smp/Benefits/")
maps = list.files("/Volumes/BioFutures1/SMP_Data/SMPv3/SppBenefits_SMPv3", pattern = "_FrequentFRB.tif", full=TRUE)

## Read in cluster data
mammal.clusters = read.csv("data_clean/mammal_traits_clustered.csv")
clusters = unique(mammal.clusters$cluster)

rasters.out = list()
for(c in clusters){
  taxon_ids = mammal.clusters %>% filter(cluster == c) %>% select(Taxon_ID)
  # Extract TaxonIDs from file paths
  extracted_ids <- as.numeric(gsub("^.*Spp([0-9]+)delta.*$", "\\1", maps))
  # Filter file paths by matching TaxonIDs
  filtered_maps <- maps[extracted_ids %in% taxon_ids$Taxon_ID]
  
  ben.stack = rast(filtered_maps)

  summed.stack = sum(ben.stack, na.rm=TRUE)
  names(summed.stack) <- paste0("Mammal_Cluster_", c)
  rasters.out[[c]] <- summed.stack
}

risk.stack = rast(rasters.out)

plot(risk.stack[[14]])


